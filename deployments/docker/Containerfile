FROM docker.io/golang:1.26-trixie AS builder

RUN groupadd -r gobfd && useradd -r -g gobfd -s /sbin/nologin gobfd

WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download && go mod verify
COPY . .

ARG VERSION=dev
ARG GIT_COMMIT=unknown
ARG BUILD_DATE=unknown
RUN CGO_ENABLED=0 go build -trimpath \
    -ldflags="-s -w \
      -X github.com/dantte-lp/gobfd/internal/version.Version=${VERSION} \
      -X github.com/dantte-lp/gobfd/internal/version.GitCommit=${GIT_COMMIT} \
      -X github.com/dantte-lp/gobfd/internal/version.BuildDate=${BUILD_DATE}" \
    -o /bin/gobfd ./cmd/gobfd
RUN CGO_ENABLED=0 go build -trimpath \
    -ldflags="-s -w \
      -X github.com/dantte-lp/gobfd/internal/version.Version=${VERSION} \
      -X github.com/dantte-lp/gobfd/internal/version.GitCommit=${GIT_COMMIT} \
      -X github.com/dantte-lp/gobfd/internal/version.BuildDate=${BUILD_DATE}" \
    -o /bin/gobfdctl ./cmd/gobfdctl

FROM scratch AS production

COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=builder /etc/passwd /etc/passwd
COPY --from=builder /etc/group /etc/group
COPY --from=builder /bin/gobfd /bin/gobfdctl /bin/

USER gobfd:gobfd

EXPOSE 3784/udp 4784/udp 50051

ENTRYPOINT ["/bin/gobfd"]
