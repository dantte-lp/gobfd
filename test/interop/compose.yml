# Interoperability test stack: GoBFD <-> FRR <-> BIRD3 <-> aiobfd <-> Thoro/bfd
#
# All containers share a custom bridge network (172.20.0.0/24)
# with static IP assignments:
#   - gobfd:   172.20.0.10  (tshark shares this network namespace)
#   - frr:     172.20.0.20
#   - bird3:   172.20.0.30
#   - scapy:   172.20.0.40  (BFD protocol fuzzer, runs once and exits)
#   - aiobfd:  172.20.0.50  (Python asyncio BFD peer, no auth)
#   - thoro:   172.20.0.60  (Go BFD peer, no auth â€” auth verify not implemented)
#
# BFD single-hop sessions are established between gobfd and each peer.
# RFC 5881: destination port 3784, source port 49152-65535, TTL=255.
#
# tshark captures all BFD traffic to /captures/ for offline analysis.
# Live decode:  podman exec tshark-interop tshark -r /captures/bfd.pcapng -V -Y bfd
# Live capture: podman exec tshark-interop tshark -i any -f "udp port 3784" -V
#
# Usage:
#   podman-compose -f test/interop/compose.yml up --build -d
#   podman-compose -f test/interop/compose.yml logs -f
#   podman-compose -f test/interop/compose.yml down

services:
  gobfd:
    build:
      context: ../..
      dockerfile: deployments/docker/Containerfile
    container_name: gobfd-interop
    user: "0:0"
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./gobfd/gobfd.yml:/etc/gobfd/gobfd.yml:ro,z
    command: ["-config", "/etc/gobfd/gobfd.yml"]
    networks:
      bfdnet:
        ipv4_address: 172.20.0.10

  frr:
    image: quay.io/frrouting/frr:10.2.5
    container_name: frr-interop
    cap_add:
      - NET_RAW
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - ./frr/daemons:/etc/frr/daemons:ro,z
      - ./frr/frr.conf:/etc/frr/frr.conf:ro,z
    networks:
      bfdnet:
        ipv4_address: 172.20.0.20

  bird3:
    build:
      context: ./bird3
      dockerfile: Containerfile
    container_name: bird3-interop
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./bird3/bird.conf:/etc/bird/bird.conf:ro,z
    networks:
      bfdnet:
        ipv4_address: 172.20.0.30

  tshark:
    build:
      context: ./tshark
      dockerfile: Containerfile
    container_name: tshark-interop
    network_mode: "service:gobfd"
    depends_on:
      - gobfd
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - captures:/captures:z

  aiobfd:
    build:
      context: ./aiobfd
      dockerfile: Containerfile
    container_name: aiobfd-interop
    depends_on:
      - gobfd
    cap_add:
      - NET_RAW
      - NET_ADMIN
    # aiobfd <local> <remote> --rx-interval <ms> --tx-interval <ms> --detect-mult <N>
    command: ["172.20.0.50", "172.20.0.10", "-r", "300", "-t", "300", "-m", "3", "-l", "DEBUG"]
    networks:
      bfdnet:
        ipv4_address: 172.20.0.50

  thoro:
    build:
      context: ./thoro
      dockerfile: Containerfile
    container_name: thoro-interop
    depends_on:
      - gobfd
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./thoro/config.yaml:/etc/bfdd/config.yaml:ro,z
    networks:
      bfdnet:
        ipv4_address: 172.20.0.60

  scapy:
    build:
      context: ./scapy
      dockerfile: Containerfile
    container_name: scapy-interop
    depends_on:
      - gobfd
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      GOBFD_IP: "172.20.0.10"
    networks:
      bfdnet:
        ipv4_address: 172.20.0.40
    profiles:
      - fuzz

volumes:
  captures:

networks:
  bfdnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
