# Interoperability test stack: GoBFD <-> FRR <-> BIRD3
#
# All three containers share a custom bridge network (172.20.0.0/24)
# with static IP assignments:
#   - gobfd:  172.20.0.10
#   - frr:    172.20.0.20
#   - bird3:  172.20.0.30
#
# BFD single-hop sessions are established between gobfd and each peer.
# RFC 5881: destination port 3784, source port 49152-65535, TTL=255.
#
# Usage:
#   podman-compose -f test/interop/compose.yml up --build -d
#   podman-compose -f test/interop/compose.yml logs -f
#   podman-compose -f test/interop/compose.yml down

services:
  gobfd:
    build:
      context: ../..
      dockerfile: deployments/docker/Containerfile
    container_name: gobfd-interop
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./gobfd/gobfd.yml:/etc/gobfd/gobfd.yml:ro,z
    command: ["-config", "/etc/gobfd/gobfd.yml"]
    networks:
      bfdnet:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["/bin/gobfdctl", "session", "list", "--addr", "127.0.0.1:50051", "--format", "json"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  frr:
    image: quay.io/frrouting/frr:10.2.5
    container_name: frr-interop
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./frr/daemons:/etc/frr/daemons:ro,z
      - ./frr/frr.conf:/etc/frr/frr.conf:ro,z
    networks:
      bfdnet:
        ipv4_address: 172.20.0.20

  bird3:
    build:
      context: ./bird3
      dockerfile: Containerfile
    container_name: bird3-interop
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./bird3/bird.conf:/etc/bird/bird.conf:ro,z
    networks:
      bfdnet:
        ipv4_address: 172.20.0.30

networks:
  bfdnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
