name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: golang:1.26-trixie
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Build
        shell: bash
        run: |
          VERSION="ci-${GITHUB_SHA::8}"
          GIT_COMMIT="${GITHUB_SHA::8}"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LDFLAGS="-s -w \
            -X github.com/dantte-lp/gobfd/internal/version.Version=${VERSION} \
            -X github.com/dantte-lp/gobfd/internal/version.GitCommit=${GIT_COMMIT} \
            -X github.com/dantte-lp/gobfd/internal/version.BuildDate=${BUILD_DATE}"
          go build -buildvcs=false -ldflags="${LDFLAGS}" ./cmd/gobfd
          go build -buildvcs=false -ldflags="${LDFLAGS}" ./cmd/gobfdctl
          go build -buildvcs=false -ldflags="${LDFLAGS}" ./cmd/gobfd-haproxy-agent
          go build -buildvcs=false -ldflags="${LDFLAGS}" ./cmd/gobfd-exabgp-bridge

      - name: Test with coverage
        run: go test -buildvcs=false ./... -race -count=1 -coverprofile=coverage.out -covermode=atomic

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v6
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    container:
      image: golang:1.26-trixie
    steps:
      - uses: actions/checkout@v6

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Lint
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
          golangci-lint run ./...

  vulnerability-check:
    runs-on: ubuntu-latest
    container:
      image: golang:1.26-trixie
    steps:
      - uses: actions/checkout@v6

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Vulnerability Check (govulncheck)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Vulnerability Check (osv-scanner)
        run: |
          go install github.com/google/osv-scanner/v2/cmd/osv-scanner@latest
          osv-scanner scan -r .

  buf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up buf
        uses: bufbuild/buf-action@v1
        with:
          setup_only: true

      - name: buf lint
        run: buf lint

      - name: buf breaking
        if: github.event_name == 'pull_request'
        run: buf breaking --against '.git#branch=${{ github.event.pull_request.base.ref }}'

  trivy:
    runs-on: ubuntu-latest
    needs: [build-and-test, lint, vulnerability-check, buf]
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy
